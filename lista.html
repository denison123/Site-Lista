<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRL_TECNOLOGIA</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div class="container">
        <h2>ðŸ›’ LISTA DE SUPERMERCADO ðŸ›’</h2>
        <div class="controles">
            <input type="text" id="pesquisa" placeholder="Buscar na lista..." onkeyup="filtrar()">
            <button class="btn-add" onclick="adicionarLinha()">+ Adicionar</button>
        </div>
        <table id="tabelaCompras">
            <thead>
                <tr>
                    <th style="width: 40px;">âœ”</th>
                    <th>Item</th>
                    <th style="width: 70px;">Qtd</th>
                    <th style="width: 100px;">PreÃ§o (R$)</th>
                    <th style="width: 100px;">Subtotal</th>
                    <th style="width: 30px;"></th>
                </tr>
            </thead>
            <tbody id="corpoTabela"></tbody>
        </table>
        <div class="total-box">
            <span style="display:block; color:var(--primary)">VALOR TOTAL DA COMPRA:</span>
            <span class="total-valor">R$ <span id="valorTotalGeral">0,00</span></span>
        </div>
        <button class="btn-limpar" onclick="limparTabela()">ðŸ§¹ Limpar Toda a Lista</button>
    </div>

    <script>
        window.onload = carregarDados;

        function adicionarLinha(nome = "", qtd = 1, valor = 0, pego = false) {
            const tabela = document.getElementById("corpoTabela");
            const novaLinha = document.createElement("tr");
            if (pego) novaLinha.classList.add("item-pego");

            novaLinha.innerHTML = `
            <td data-label="Pego?"><input type="checkbox" class="chk-pego" ${pego ? 'checked' : ''} onclick="marcarItem(this)"></td>
            <td data-label="Item"><input type="text" class="nome-item" placeholder="Ex: CafÃ©" value="${nome}" oninput="salvarDados()"></td>
            <td data-label="Qtd"><input type="number" class="qtd-item" value="${qtd}" min="1" oninput="calcular()"></td>
            <td data-label="PreÃ§o"><input type="text" class="preco-item" value="${valor > 0 ? formatarMoeda(valor) : ''}" oninput="calcular()" placeholder="0,00"></td>
            <td data-label="Subtotal" class="subtotal-item" style="font-weight: bold; text-align:right">0,00</td>
            <td><button class="btn-del" onclick="removerLinha(this)">ðŸ—‘</button></td>
        `;
            tabela.insertBefore(novaLinha, tabela.firstChild);
            calcular();
        }

        function marcarItem(checkbox) {
            const linha = checkbox.closest("tr");
            checkbox.checked ? linha.classList.add("item-pego") : linha.classList.remove("item-pego");
            salvarDados();
        }

        function removerLinha(btn) {
            btn.closest("tr").remove();
            calcular();
        }

        function converterParaNumero(valorString) {
            if (!valorString) return 0;
            let limpo = valorString.replace(/\./g, '').replace(',', '.');
            return parseFloat(limpo) || 0;
        }

        function formatarMoeda(valor) {
            return valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function calcular() {
            let somaTotal = 0;
            const linhas = document.querySelectorAll("#corpoTabela tr");

            linhas.forEach(linha => {
                const qtd = parseFloat(linha.querySelector(".qtd-item").value) || 0;
                const preco = converterParaNumero(linha.querySelector(".preco-item").value);
                const subtotal = qtd * preco;

                linha.querySelector(".subtotal-item").innerText = formatarMoeda(subtotal);
                somaTotal += subtotal; // Agora soma tudo, independente do checkbox
            });

            document.getElementById("valorTotalGeral").innerText = formatarMoeda(somaTotal);
            salvarDados();
        }

        function filtrar() {
            const busca = document.getElementById("pesquisa").value.toLowerCase();
            document.querySelectorAll("#corpoTabela tr").forEach(linha => {
                const nome = linha.querySelector(".nome-item").value.toLowerCase();
                linha.style.display = nome.includes(busca) ? "" : "none";
            });
        }

        function salvarDados() {
            const dados = [];
            document.querySelectorAll("#corpoTabela tr").forEach(linha => {
                dados.push({
                    pego: linha.querySelector(".chk-pego").checked,
                    nome: linha.querySelector(".nome-item").value,
                    qtd: linha.querySelector(".qtd-item").value,
                    valor: converterParaNumero(linha.querySelector(".preco-item").value)
                });
            });
            localStorage.setItem("listaCompras_V3", JSON.stringify(dados));
        }

        function carregarDados() {
            const salvo = localStorage.getItem("listaCompras_V3");
            if (salvo) {
                const dados = JSON.parse(salvo);
                document.getElementById("corpoTabela").innerHTML = "";
                dados.reverse().forEach(item => adicionarLinha(item.nome, item.qtd, item.valor, item.pego));
            } else {
                adicionarLinha();
            }
        }

        function limparTabela() {
            if (confirm("Limpar toda a lista?")) {
                localStorage.removeItem("listaCompras_V3");
                location.reload();
            }
        }
    </script>
</body>

</html>